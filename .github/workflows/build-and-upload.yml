# .github/workflows/build-and-upload.yml
name: Build and Upload Executable

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  

env:
  GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME_FOR_API_DOCS }}
  GCS_BUCKET_PATH: "source-code/go-openapi-generator"
  EXECUTABLE_NAME: "openapi-generator-linux-amd64"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Get Version Info
        id: version
        run: |
          # Use git describe to get version info
          VERSION=$(git describe --tags --always --dirty)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "build_name=${{ env.EXECUTABLE_NAME }}-$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build Executable
        run: |
          echo "Building OpenAPI generator for Linux AMD64..."
          
          # Download dependencies
          go mod download
          
          # Build with version information
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=${{ steps.version.outputs.timestamp }}" \
            -o ${{ env.EXECUTABLE_NAME }} \
            .
          
          # Make it executable
          chmod +x ${{ env.EXECUTABLE_NAME }}
          
          # Verify the build
          file ${{ env.EXECUTABLE_NAME }}
          ls -la ${{ env.EXECUTABLE_NAME }}
      
      - name: Create Metadata File
        run: |
          cat > metadata.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "commit": "${{ github.sha }}",
            "short_sha": "${{ steps.version.outputs.short_sha }}",
            "build_time": "${{ steps.version.outputs.timestamp }}",
            "github_run_id": "${{ github.run_id }}",
            "github_ref": "${{ github.ref }}",
            "github_actor": "${{ github.actor }}"
          }
          EOF
          
          cat metadata.json
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_FOR_API_DOCS }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Upload to GCS
        run: |
          echo "Uploading executable to GCS..."
          
          # Upload the latest executable (always overwrite)
          gsutil -h "Cache-Control:no-cache, max-age=0" \
            cp ${{ env.EXECUTABLE_NAME }} \
            gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/${{ env.EXECUTABLE_NAME }}
          
          # Upload metadata
          gsutil -h "Cache-Control:no-cache, max-age=0" \
            -h "Content-Type:application/json" \
            cp metadata.json \
            gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/metadata.json
          
          # Also upload a versioned copy for history
          gsutil cp ${{ env.EXECUTABLE_NAME }} \
            gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/versions/${{ steps.version.outputs.build_name }}
          
          echo "âœ… Executable uploaded successfully"
          echo "Latest: gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/${{ env.EXECUTABLE_NAME }}"
          echo "Versioned: gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/versions/${{ steps.version.outputs.build_name }}"
      
      - name: Verify Upload
        run: |
          echo "Verifying uploaded files..."
          gsutil ls -l gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/
          
          echo ""
          echo "Checking file size..."
          gsutil du -h gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/${{ env.EXECUTABLE_NAME }}
      
      - name: Create Summary
        run: |
          echo "## ðŸš€ Build and Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ steps.version.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time**: \`${{ steps.version.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Uploaded Files:" >> $GITHUB_STEP_SUMMARY
          echo "- Latest executable: \`gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/latest/${{ env.EXECUTABLE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Versioned copy: \`gs://${{ env.GCS_BUCKET_NAME }}/${{ env.GCS_BUCKET_PATH }}/versions/${{ steps.version.outputs.build_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The executable is now available for use in GitHub Actions! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY